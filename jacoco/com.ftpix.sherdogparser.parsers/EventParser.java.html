<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>EventParser.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">sherdog-parser</a> &gt; <a href="index.source.html" class="el_package">com.ftpix.sherdogparser.parsers</a> &gt; <span class="el_source">EventParser.java</span></div><h1>EventParser.java</h1><pre class="source lang-java linenums">package com.ftpix.sherdogparser.parsers;

import com.ftpix.sherdogparser.Constants;
import com.ftpix.sherdogparser.models.Event;
import com.ftpix.sherdogparser.models.Fight;
import com.ftpix.sherdogparser.models.FightResult;
import com.ftpix.sherdogparser.models.SherdogBaseObject;

import org.jsoup.Jsoup;
import org.jsoup.nodes.Document;
import org.jsoup.nodes.Element;
import org.jsoup.select.Elements;
import org.slf4j.Logger;
import org.slf4j.LoggerFactory;

import java.io.IOException;
import java.text.ParseException;
import java.time.ZoneId;
import java.time.format.DateTimeParseException;
import java.util.ArrayList;
import java.util.List;

/**
 * Created by gz on 20-Aug-16.
 * Class to parse an event by using its sherdog url
 */
public class EventParser implements SherdogParser&lt;Event&gt; {
<span class="pc" id="L28">    private final int FIGHTER1_COLUMN = 1, FIGHTER2_COLUMN = 3, METHOD_COLUMN = 4, ROUND_COLUMN = 5, TIME_COLUMN = 6;</span>
<span class="pc" id="L29">    private final Logger logger = LoggerFactory.getLogger(EventParser.class);</span>

    private final ZoneId ZONE_ID;

    /**
     * Setting a zoneId will convert the dates to the desired zone id
     */
<span class="fc" id="L36">    public EventParser(ZoneId zoneId) {</span>
<span class="fc" id="L37">        this.ZONE_ID = zoneId;</span>
<span class="fc" id="L38">    }</span>

    /**
     * Creates an event parser with the default zone id
     */
<span class="nc" id="L43">    public EventParser() {</span>
<span class="nc" id="L44">        this.ZONE_ID = ZoneId.systemDefault();</span>
<span class="nc" id="L45">    }</span>

    /**
     * Parse a sherdog page
     *
     * @param url of the sherdog page
     * @throws IOException    if connecting to sherdog fails
     * @throws ParseException if the page structure has changed
     */
    @Override
    public Event parse(String url) throws IOException, ParseException {
<span class="fc" id="L56">        Event event = new Event();</span>
<span class="fc" id="L57">        event.setSherdogUrl(url);</span>

<span class="fc" id="L59">        Document doc = Jsoup.connect(url).timeout(Constants.PARSING_TIMEOUT).get();</span>

        //getting name
<span class="fc" id="L62">        Elements name = doc.select(&quot;.header .section_title h1 span[itemprop=\&quot;name\&quot;]&quot;);</span>
<span class="fc" id="L63">        event.setName(name.html().replace(&quot;&lt;br&gt;&quot;, &quot; - &quot;));</span>

<span class="fc" id="L65">        Elements date = doc.select(&quot;.authors_info .date meta[itemprop=\&quot;startDate\&quot;]&quot;);</span>
        //TODO: get date to proper format
        try {
<span class="fc" id="L68">            event.setDate(ParserUtils.getDateFromStringToZoneId(date.first().attr(&quot;content&quot;), ZONE_ID));</span>
<span class="nc" id="L69">        } catch (DateTimeParseException e) {</span>
<span class="nc" id="L70">            logger.error(&quot;Couldn't parse date&quot;, e);</span>
<span class="fc" id="L71">        }</span>


<span class="fc" id="L74">        getFights(doc, event);</span>

<span class="fc" id="L76">        Element org = doc.select(&quot;.header .section_title h2 a&quot;).get(0);</span>
<span class="fc" id="L77">        SherdogBaseObject organization = new SherdogBaseObject();</span>
<span class="fc" id="L78">        organization.setSherdogUrl(org.attr(&quot;abs:href&quot;));</span>
<span class="fc" id="L79">        organization.setName(org.select(&quot;span[itemprop=\&quot;name\&quot;&quot;).get(0).html());</span>

<span class="fc" id="L81">        event.setOrganization(organization);</span>
<span class="fc" id="L82">        return event;</span>
    }


    /**
     * Gets the fight of the event
     *
     * @param doc   the jsoup HTML document
     * @param event The current event
     */
    private void getFights(Document doc, Event event) {
<span class="fc" id="L93">        logger.info(&quot;Getting fights for event #{}[{}]&quot;, event.getSherdogUrl(), event.getName());</span>

<span class="fc" id="L95">        SherdogBaseObject sEvent = new SherdogBaseObject();</span>
<span class="fc" id="L96">        sEvent.setName(event.getName());</span>
<span class="fc" id="L97">        sEvent.setSherdogUrl(event.getSherdogUrl());</span>

<span class="fc" id="L99">        List&lt;Fight&gt; fights = new ArrayList&lt;&gt;();</span>

        //Checking on main event
<span class="fc" id="L102">        Elements mainFightElement = doc.select(&quot;.content.event&quot;);</span>

<span class="fc" id="L104">        Elements fighters = mainFightElement.select(&quot;h3 a&quot;);</span>
        //First fighter
<span class="fc" id="L106">        SherdogBaseObject mainFighter1 = new SherdogBaseObject();</span>
<span class="fc" id="L107">        Element mainFighter1Element = fighters.get(0);</span>
<span class="fc" id="L108">        mainFighter1.setSherdogUrl(mainFighter1Element.attr(&quot;abs:href&quot;));</span>
<span class="fc" id="L109">        mainFighter1.setName(mainFighter1Element.select(&quot;span[itemprop=\&quot;name\&quot;]&quot;).html());</span>

        //second fighter
<span class="fc" id="L112">        SherdogBaseObject mainFighter2 = new SherdogBaseObject();</span>
<span class="fc" id="L113">        Element mainFighter2Element = fighters.get(1);</span>
<span class="fc" id="L114">        mainFighter2.setSherdogUrl(mainFighter2Element.attr(&quot;abs:href&quot;));</span>
<span class="fc" id="L115">        mainFighter2.setName(mainFighter2Element.select(&quot;span[itemprop=\&quot;name\&quot;]&quot;).html());</span>


<span class="fc" id="L118">        Fight mainFight = new Fight();</span>
<span class="fc" id="L119">        mainFight.setEvent(sEvent);</span>
<span class="fc" id="L120">        mainFight.setFighter1(mainFighter1);</span>
<span class="fc" id="L121">        mainFight.setFighter2(mainFighter2);</span>
<span class="fc" id="L122">        mainFight.setResult(ParserUtils.getFightResult(mainFightElement.first()));</span>

        //getting method
<span class="fc" id="L125">        Elements mainTd = mainFightElement.select(&quot;td&quot;);</span>
<span class="pc bpc" id="L126" title="1 of 2 branches missed.">        if (mainTd.size() &gt; 0) {</span>
<span class="fc" id="L127">            mainFight.setWinMethod(mainTd.get(1).html().replaceAll(&quot;&lt;em(.*)&lt;br&gt;&quot;, &quot;&quot;).trim());</span>
<span class="fc" id="L128">            mainFight.setWinRound(Integer.parseInt(mainTd.get(3).html().replaceAll(&quot;&lt;em(.*)&lt;br&gt;&quot;, &quot;&quot;).trim()));</span>
<span class="fc" id="L129">            mainFight.setWinTime(mainTd.get(4).html().replaceAll(&quot;&lt;em(.*)&lt;br&gt;&quot;, &quot;&quot;).trim());</span>
        }
<span class="fc" id="L131">        mainFight.setDate(event.getDate());</span>


<span class="fc" id="L134">        fights.add(mainFight);</span>
<span class="fc" id="L135">        logger.info(&quot;Fight added: {}&quot;, mainFight);</span>
        //Checking on card results

<span class="fc" id="L138">        logger.info(&quot;Found {} fights&quot;, fights.size());</span>

<span class="fc" id="L140">        Elements tds = doc.select(&quot;.event_match table tr&quot;);</span>

<span class="fc" id="L142">        fights.addAll(parseEventFights(tds, event));</span>


<span class="fc" id="L145">        event.setFights(fights);</span>
<span class="fc" id="L146">    }</span>



    /**
     * Parse fights of an old event
     */
    private List&lt;Fight&gt; parseEventFights(Elements trs, Event event) {
<span class="fc" id="L154">        SherdogBaseObject sEvent = new SherdogBaseObject();</span>
<span class="fc" id="L155">        sEvent.setName(event.getName());</span>
<span class="fc" id="L156">        sEvent.setSherdogUrl(event.getSherdogUrl());</span>

<span class="fc" id="L158">        List&lt;Fight&gt; fights = new ArrayList&lt;&gt;();</span>

<span class="fc" id="L160">        trs.remove(0);</span>

<span class="fc" id="L162">        trs.forEach(tr -&gt; {</span>
<span class="fc" id="L163">            Fight fight = new Fight();</span>
<span class="fc" id="L164">            fight.setEvent(sEvent);</span>
<span class="fc" id="L165">            fight.setDate(event.getDate());</span>
<span class="fc" id="L166">            Elements tds = tr.select(&quot;td&quot;);</span>

<span class="fc" id="L168">            fight.setFighter1(getFighter(tds.get(FIGHTER1_COLUMN)));</span>
<span class="fc" id="L169">            fight.setFighter2(getFighter(tds.get(FIGHTER2_COLUMN)));</span>

            //parsing old fight, we can get the result
<span class="pc bpc" id="L172" title="1 of 2 branches missed.">            if (tds.size() == 7) {</span>
<span class="fc" id="L173">                fight.setResult(getResult(tds.get(FIGHTER1_COLUMN)));</span>
<span class="fc" id="L174">                fight.setWinMethod(getMethod(tds.get(METHOD_COLUMN)));</span>
<span class="fc" id="L175">                fight.setWinRound(getRound(tds.get(ROUND_COLUMN)));</span>
<span class="fc" id="L176">                fight.setWinTime(getTime(tds.get(TIME_COLUMN)));</span>
            }

<span class="fc" id="L179">            fights.add(fight);</span>
<span class="fc" id="L180">            logger.info(&quot;Fight added: {}&quot;, fight);</span>
<span class="fc" id="L181">        });</span>

<span class="fc" id="L183">        return fights;</span>
    }

    /**
     * Get a fighter
     * @param td element from sherdog's table
     * @return return a sherdogbaseobject with the fighter name and url
     */
    private SherdogBaseObject getFighter(Element td) {

<span class="fc" id="L193">        Elements name1 = td.select(&quot;span[itemprop=\&quot;name\&quot;]&quot;);</span>
<span class="fc" id="L194">        String name = name1.get(0).html();</span>
<span class="fc" id="L195">        String url = td.select(&quot;a[itemprop=\&quot;url\&quot;]&quot;).get(0).attr(&quot;abs:href&quot;);</span>

<span class="fc" id="L197">        SherdogBaseObject fighter = new SherdogBaseObject();</span>
<span class="fc" id="L198">        fighter.setSherdogUrl(url);</span>
<span class="fc" id="L199">        fighter.setName(name);</span>
<span class="fc" id="L200">        return fighter;</span>
    }

    /**
     * get the time at which teh fight finished
     * @param td element from sherdog's table
     * @return get the time of the event
     */
    private String getTime(Element td) {
<span class="fc" id="L209">        return td.html();</span>
    }


    /**
     * get the round at which the even finished
     * @param td element from sherdog's table
     * @return the round number
     */
    private int getRound(Element td) {
<span class="fc" id="L219">        return Integer.parseInt(td.html());</span>
    }


    /**
     *
     * @param td element from sherdog's table
     * @return get the win method
     */
    private String getMethod(Element td) {
<span class="fc" id="L229">        return td.html().replaceAll(&quot;&lt;br&gt;(.*)&quot;, &quot;&quot;);</span>
    }

    /**
     *  get the result of the fight
     * @param td element from sherdog's table
     * @return a rightresult enum
     */
    private FightResult getResult(Element td) {
<span class="fc" id="L238">        return ParserUtils.getFightResult(td);</span>
    }

}
</pre><div class="footer"><span class="right">Created with <a href="http://www.eclemma.org/jacoco">JaCoCo</a> 0.7.7.201606060606</span></div></body></html>