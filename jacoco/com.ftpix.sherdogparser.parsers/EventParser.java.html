<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>EventParser.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">sherdog-parser</a> &gt; <a href="index.source.html" class="el_package">com.ftpix.sherdogparser.parsers</a> &gt; <span class="el_source">EventParser.java</span></div><h1>EventParser.java</h1><pre class="source lang-java linenums">package com.ftpix.sherdogparser.parsers;

import com.ftpix.sherdogparser.Constants;
import com.ftpix.sherdogparser.models.Event;
import com.ftpix.sherdogparser.models.Fight;
import com.ftpix.sherdogparser.models.SherdogBaseObject;

import org.jsoup.Jsoup;
import org.jsoup.nodes.Document;
import org.jsoup.nodes.Element;
import org.jsoup.select.Elements;
import org.slf4j.Logger;
import org.slf4j.LoggerFactory;

import java.io.IOException;
import java.text.ParseException;
import java.time.ZoneId;
import java.time.ZonedDateTime;
import java.time.format.DateTimeParseException;
import java.util.ArrayList;
import java.util.Collection;
import java.util.List;

/**
 * Created by gz on 20-Aug-16.
 */
public class EventParser implements SherdogParser&lt;Event&gt; {
<span class="pc" id="L28">    private final int FIGHTER1_COLUMN = 2, FIGHTER2_COLUMN = 4, METHOD_COLUMN = 5, ROUND_COLUMN = 6, TIME_COLUMN = 0;</span>
<span class="pc" id="L29">    private final Logger logger = LoggerFactory.getLogger(EventParser.class);</span>

    private final ZoneId ZONE_ID;

    /**
     * Setting a zoneId will convert the dates to the desired zone id
     */
<span class="fc" id="L36">    public EventParser(ZoneId zoneId) {</span>
<span class="fc" id="L37">        this.ZONE_ID = zoneId;</span>
<span class="fc" id="L38">    }</span>

    /**
     * Creates an event parser with the default zone id
     */
<span class="nc" id="L43">    public EventParser() {</span>
<span class="nc" id="L44">        this.ZONE_ID = ZoneId.systemDefault();</span>
<span class="nc" id="L45">    }</span>

    /**
     * Parse a sherdog page
     *
     * @param url of the sherdog page
     * @throws IOException    if connecting to sherdog fails
     * @throws ParseException if the page structure has changed
     */
    @Override
    public Event parse(String url) throws IOException, ParseException {
<span class="fc" id="L56">        Event event = new Event();</span>
<span class="fc" id="L57">        event.setSherdogUrl(url);</span>

<span class="fc" id="L59">        Document doc = Jsoup.connect(url).timeout(Constants.PARSING_TIMEOUT).get();</span>

        //getting name
<span class="fc" id="L62">        Elements name = doc.select(&quot;.header .section_title h1 span[itemprop=\&quot;name\&quot;]&quot;);</span>
<span class="fc" id="L63">        event.setName(name.html().replace(&quot;&lt;br&gt;&quot;, &quot; - &quot;));</span>

<span class="fc" id="L65">        Elements date = doc.select(&quot;.authors_info .date meta[itemprop=\&quot;startDate\&quot;]&quot;);</span>
        //TODO: get date to proper format
        try {
<span class="fc" id="L68">            event.setDate(ParserUtils.getDateFromStringToZoneId(date.first().attr(&quot;content&quot;), ZONE_ID));</span>
<span class="nc" id="L69">        } catch (DateTimeParseException e) {</span>
<span class="nc" id="L70">            logger.error(&quot;Couldn't parse date&quot;, e);</span>
<span class="fc" id="L71">        }</span>


<span class="fc" id="L74">        getFights(doc, event);</span>

<span class="fc" id="L76">        Element org = doc.select(&quot;.header .section_title h2 a&quot;).get(0);</span>
<span class="fc" id="L77">        SherdogBaseObject organization = new SherdogBaseObject();</span>
<span class="fc" id="L78">        organization.setSherdogUrl(org.attr(&quot;abs:href&quot;));</span>
<span class="fc" id="L79">        organization.setName(org.select(&quot;span[itemprop=\&quot;name\&quot;&quot;).get(0).html());</span>

<span class="fc" id="L81">        event.setOrganization(organization);</span>
<span class="fc" id="L82">        return event;</span>
    }


    /**
     * Gets the fight of the event
     *
     * @param doc   the jsoup HTML document
     * @param event The current event
     */
    private void getFights(Document doc, Event event) {
<span class="fc" id="L93">        logger.info(&quot;Getting fights for event #{}[{}]&quot;, event.getSherdogUrl(), event.getName());</span>

<span class="fc" id="L95">        SherdogBaseObject sEvent = new SherdogBaseObject();</span>
<span class="fc" id="L96">        sEvent.setName(event.getName());</span>
<span class="fc" id="L97">        sEvent.setSherdogUrl(event.getSherdogUrl());</span>

<span class="fc" id="L99">        List&lt;Fight&gt; fights = new ArrayList&lt;Fight&gt;();</span>

        //Checking on main event
<span class="fc" id="L102">        Elements mainFightElement = doc.select(&quot;.content.event&quot;);</span>

<span class="fc" id="L104">        Elements fighters = mainFightElement.select(&quot;h3 a&quot;);</span>
        //First fighter
<span class="fc" id="L106">        SherdogBaseObject mainFighter1 = new SherdogBaseObject();</span>
<span class="fc" id="L107">        Element mainFighter1Element = fighters.get(0);</span>

<span class="fc" id="L109">        mainFighter1.setSherdogUrl(mainFighter1Element.attr(&quot;abs:href&quot;));</span>
<span class="fc" id="L110">        mainFighter1.setName(mainFighter1Element.select(&quot;span[itemprop=\&quot;name\&quot;]&quot;).html());</span>

        //second fighter
<span class="fc" id="L113">        SherdogBaseObject mainFighter2 = new SherdogBaseObject();</span>
<span class="fc" id="L114">        Element mainFighter2Element = fighters.get(1);</span>
<span class="fc" id="L115">        mainFighter2.setSherdogUrl(mainFighter2Element.attr(&quot;abs:href&quot;));</span>
<span class="fc" id="L116">        mainFighter2.setName(mainFighter2Element.select(&quot;span[itemprop=\&quot;name\&quot;]&quot;).html());</span>


<span class="fc" id="L119">        Fight mainFight = new Fight();</span>
<span class="fc" id="L120">        mainFight.setEvent(sEvent);</span>
<span class="fc" id="L121">        mainFight.setFighter1(mainFighter1);</span>
<span class="fc" id="L122">        mainFight.setFighter2(mainFighter2);</span>
<span class="fc" id="L123">        mainFight.setResult(ParserUtils.getFightResult(mainFightElement.first()));</span>

        //getting method
<span class="fc" id="L126">        Elements mainTd = mainFightElement.select(&quot;td&quot;);</span>
<span class="pc bpc" id="L127" title="1 of 2 branches missed.">        if (mainTd.size() &gt; 0) {</span>
<span class="fc" id="L128">            mainFight.setWinMethod(mainTd.get(1).html().replaceAll(&quot;&lt;em(.*)&lt;br&gt;&quot;, &quot;&quot;).trim());</span>
<span class="fc" id="L129">            mainFight.setWinRound(Integer.parseInt(mainTd.get(3).html().replaceAll(&quot;&lt;em(.*)&lt;br&gt;&quot;, &quot;&quot;).trim()));</span>
<span class="fc" id="L130">            mainFight.setWinTime(mainTd.get(4).html().replaceAll(&quot;&lt;em(.*)&lt;br&gt;&quot;, &quot;&quot;).trim());</span>
        }
<span class="fc" id="L132">        mainFight.setDate(event.getDate());</span>


<span class="fc" id="L135">        fights.add(mainFight);</span>
<span class="fc" id="L136">        logger.info(&quot;Fight added: {}&quot;, mainFight);</span>
        //Checking on card results

<span class="fc" id="L139">        logger.info(&quot;Found {} fights&quot;, fights.size());</span>

        try {
<span class="fc" id="L142">            Elements tds = doc.select(&quot;.event_match table td&quot;);</span>

<span class="fc" id="L144">            fights.addAll(parseOldEventFights(tds, event));</span>
<span class="nc" id="L145">        } catch (IndexOutOfBoundsException e) {</span>
<span class="nc" id="L146">            Elements tds = doc.select(&quot;.event_match table td&quot;);</span>

<span class="nc" id="L148">            fights.addAll(parseFutureEventFights(tds, event));</span>
<span class="fc" id="L149">        }</span>

<span class="fc" id="L151">        event.setFights(fights);</span>
<span class="fc" id="L152">    }</span>


    /**
     * Parse new events
     */
    private Collection&lt;? extends Fight&gt; parseFutureEventFights(Elements tds, Event event) {
<span class="nc" id="L159">        SherdogBaseObject sEvent = new SherdogBaseObject();</span>
<span class="nc" id="L160">        sEvent.setName(event.getName());</span>
<span class="nc" id="L161">        sEvent.setSherdogUrl(event.getSherdogUrl());</span>

<span class="nc" id="L163">        List&lt;Fight&gt; fights = new ArrayList&lt;Fight&gt;();</span>

<span class="nc" id="L165">        int i = 1;</span>

<span class="nc" id="L167">        Fight fight = new Fight();</span>

<span class="nc" id="L169">        tds.remove(0);</span>
<span class="nc" id="L170">        tds.remove(0);</span>

<span class="nc bnc" id="L172" title="All 2 branches missed.">        for (Element td : tds) {</span>

            String name, url;
<span class="nc" id="L175">            SherdogBaseObject fighter = new SherdogBaseObject();</span>
<span class="nc bnc" id="L176" title="All 3 branches missed.">            switch (i % 4) {</span>

                case 2:
<span class="nc" id="L179">                    Elements name1 = td.select(&quot;span[itemprop=\&quot;name\&quot;]&quot;);</span>
<span class="nc" id="L180">                    name = name1.get(0).html();</span>
<span class="nc" id="L181">                    url = td.select(&quot;a[itemprop=\&quot;url\&quot;]&quot;).get(0).attr(&quot;abs:href&quot;);</span>

<span class="nc" id="L183">                    fighter.setSherdogUrl(url);</span>
<span class="nc" id="L184">                    fighter.setName(name);</span>

<span class="nc" id="L186">                    fight.setFighter1(fighter);</span>
<span class="nc" id="L187">                    break;</span>
                case 0:
<span class="nc" id="L189">                    Elements name2 = td.select(&quot;span[itemprop=\&quot;name\&quot;]&quot;);</span>

<span class="nc" id="L191">                    name = name2.get(0).html();</span>
<span class="nc" id="L192">                    url = td.select(&quot;a[itemprop=\&quot;url\&quot;]&quot;).get(0).attr(&quot;abs:href&quot;);</span>

<span class="nc" id="L194">                    fighter.setSherdogUrl(url);</span>
<span class="nc" id="L195">                    fighter.setName(name);</span>
<span class="nc" id="L196">                    fight.setFighter2(fighter);</span>


<span class="nc" id="L199">                    fight.setEvent(sEvent);</span>
<span class="nc" id="L200">                    fight.setDate(event.getDate());</span>
<span class="nc" id="L201">                    fights.add(fight);</span>
<span class="nc" id="L202">                    logger.info(&quot;Fight added: {}&quot;, fight);</span>

<span class="nc" id="L204">                    fight = new Fight();</span>
<span class="nc" id="L205">                    break;</span>
                default:
                    break;
            }
<span class="nc" id="L209">            i++;</span>

<span class="nc" id="L211">        }</span>

<span class="nc" id="L213">        return fights;</span>
    }


    /**
     * Parse fights of an old event
     */
    private List&lt;Fight&gt; parseOldEventFights(Elements tds, Event event) {
<span class="fc" id="L221">        SherdogBaseObject sEvent = new SherdogBaseObject();</span>
<span class="fc" id="L222">        sEvent.setName(event.getName());</span>
<span class="fc" id="L223">        sEvent.setSherdogUrl(event.getSherdogUrl());</span>

<span class="fc" id="L225">        List&lt;Fight&gt; fights = new ArrayList&lt;Fight&gt;();</span>

<span class="fc" id="L227">        int i = 1;</span>

<span class="fc" id="L229">        Fight fight = new Fight();</span>

<span class="fc" id="L231">        tds.remove(0);</span>
<span class="fc" id="L232">        tds.remove(0);</span>
<span class="fc" id="L233">        tds.remove(0);</span>
<span class="fc" id="L234">        tds.remove(0);</span>
<span class="fc" id="L235">        tds.remove(0);</span>

<span class="fc bfc" id="L237" title="All 2 branches covered.">        for (Element td : tds) {</span>

            String name, url;
<span class="fc" id="L240">            SherdogBaseObject fighter = new SherdogBaseObject();</span>

<span class="fc bfc" id="L242" title="All 6 branches covered.">            switch (i % 7) {</span>

                case FIGHTER1_COLUMN:
<span class="fc" id="L245">                    Elements name1 = td.select(&quot;span[itemprop=\&quot;name\&quot;]&quot;);</span>
<span class="fc" id="L246">                    name = name1.get(0).html();</span>
<span class="fc" id="L247">                    url = td.select(&quot;a[itemprop=\&quot;url\&quot;]&quot;).get(0).attr(&quot;abs:href&quot;);</span>

<span class="fc" id="L249">                    fighter.setSherdogUrl(url);</span>
<span class="fc" id="L250">                    fighter.setName(name);</span>

<span class="fc" id="L252">                    fight.setFighter1(fighter);</span>
<span class="fc" id="L253">                    fight.setResult(ParserUtils.getFightResult(td));</span>
<span class="fc" id="L254">                    break;</span>
                case FIGHTER2_COLUMN:
<span class="fc" id="L256">                    Elements name2 = td.select(&quot;span[itemprop=\&quot;name\&quot;]&quot;);</span>

<span class="fc" id="L258">                    name = name2.get(0).html();</span>
<span class="fc" id="L259">                    url = td.select(&quot;a[itemprop=\&quot;url\&quot;]&quot;).get(0).attr(&quot;abs:href&quot;);</span>

<span class="fc" id="L261">                    fighter.setSherdogUrl(url);</span>
<span class="fc" id="L262">                    fighter.setName(name);</span>
<span class="fc" id="L263">                    fight.setFighter2(fighter);</span>
<span class="fc" id="L264">                    break;</span>
                case METHOD_COLUMN:
<span class="fc" id="L266">                    fight.setWinMethod(td.html().replaceAll(&quot;&lt;br&gt;(.*)&quot;, &quot;&quot;));</span>
<span class="fc" id="L267">                    break;</span>
                case ROUND_COLUMN:
<span class="fc" id="L269">                    fight.setWinRound(Integer.parseInt(td.html()));</span>
<span class="fc" id="L270">                    break;</span>
                case TIME_COLUMN:
<span class="fc" id="L272">                    fight.setWinTime(td.html());</span>

<span class="fc" id="L274">                    fight.setEvent(sEvent);</span>
<span class="fc" id="L275">                    fight.setDate(event.getDate());</span>
<span class="fc" id="L276">                    fights.add(fight);</span>
<span class="fc" id="L277">                    logger.info(&quot;Fight added: {}&quot;, fight);</span>

<span class="fc" id="L279">                    fight = new Fight();</span>
<span class="fc" id="L280">                    break;</span>
                default:
                    break;
            }
<span class="fc" id="L284">            i++;</span>

<span class="fc" id="L286">        }</span>

<span class="fc" id="L288">        return fights;</span>

    }
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.eclemma.org/jacoco">JaCoCo</a> 0.7.7.201606060606</span></div></body></html>